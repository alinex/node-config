<!DOCTYPE html>
<html>
<head>
  <title>load.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "src/load.coffee";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0" /></head>
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io"
  onmouseover="logo.src='https://alinex.github.io/images/Alinex-200.png'"
  onmouseout="logo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="logo" src="https://alinex.github.io/images/Alinex-black-200.png"
    width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png"
    style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog"
    class="btn btn-primary"><span class="glyphicon-pencil"></span> Blog</a>
  <a href="http://alinex.github.io/develop"
    class="btn btn-primary"><span class="glyphicon-book"></span> Develop</a>
  <a href="http://alinex.github.io/code.html"
    class="btn btn-warning"><span class="glyphicon-cog"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#load-files">Load files</a>
      </div>

      <div class="heading h2">
        <a href="#node-modules">Node Modules</a>
      </div>

      <div class="heading h2">
        <a href="#initialize-origins">Initialize origins</a>
      </div>

      <div class="heading h3">
        <a href="#validate-new-value-before-store">Validate new value before store</a>
      </div>

      <div class="heading h2">
        <a href="#loading">Loading</a>
      </div>

      <div class="heading h3">
        <a href="#get-a-flat-list-of-origins">Get a flat list of origins</a>
      </div>

      <div class="heading h3">
        <a href="#load-origin-if-necessary">Load origin if necessary</a>
      </div>

      <div class="heading h3">
        <a href="#load-file-origin">Load file origin</a>
      </div>

      <div class="heading h3">
        <a href="#load-file-origin-1">Load file origin</a>
      </div>

      <div class="heading h3">
        <a href="#set-the-extracted-information-to-the-origin-element">Set the extracted information to the origin element</a>
      </div>

      <div class="heading h3">
        <a href="#set-meta-data-to-all-elements">Set Meta Data to all elements</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-config" title="Fork me on GitHub"></a>
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="load-files">
  <h1>
    <a href="#load-files" name="load-files" class="pilcrow"></a>
Load files
  </h1>
</div>
<p>This will load and validate the configuration.</p>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="node-modules">
  <h2>
    <a href="#node-modules" name="node-modules" class="pilcrow"></a>
Node Modules
  </h2>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>include base modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'config:load'</span>)
chalk = <span class="hljs-built_in">require</span> <span class="hljs-string">'chalk'</span>
async = <span class="hljs-built_in">require</span> <span class="hljs-string">'async'</span>
fspath = <span class="hljs-built_in">require</span> <span class="hljs-string">'path'</span>
request = <span class="hljs-literal">null</span> <span class="hljs-comment"># loaded on demand</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>include more alinex modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">fs = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-fs'</span>
util = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-util'</span>
validator = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-validator'</span>
formatter = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-formatter'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="initialize-origins">
  <h2>
    <a href="#initialize-origins" name="initialize-origins" class="pilcrow"></a>
Initialize origins
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">
exports.init = <span class="hljs-function"><span class="hljs-params">(config, cb)</span> -&gt;</span>
  debug <span class="hljs-string">"load all unloaded configurations"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>step through origins</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  origins = listOrigins config.origin
  .filter (e) -&gt; e.type <span class="hljs-keyword">is</span> <span class="hljs-string">'config'</span>
  async.each origins, loadOrigin, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>combine all</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    value = {}
    meta = {}
    <span class="hljs-keyword">for</span> origin <span class="hljs-keyword">in</span> origins</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>put together</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      util.extend value, origin.value
      util.extend meta, origin.meta</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>validate</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    validate config, value, <span class="hljs-function"><span class="hljs-params">(err, value)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>set</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      config.value = value
      config.meta = meta
      cb()

exports.typeSearch = <span class="hljs-function"><span class="hljs-params">(config, type, cb)</span> -&gt;</span>
  origins = listOrigins config.origin
  .filter (e) -&gt; e.type <span class="hljs-keyword">is</span> type
  async.map origins, <span class="hljs-function"><span class="hljs-params">(origin, cb)</span> -&gt;</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>find files</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    parts = origin.uri.match <span class="hljs-regexp">///
      ^
      (
        [^?*[{@]*$    <span class="hljs-comment"># everything till end without pattern</span>
      |
        [^?*[{@]*\/   <span class="hljs-comment"># everything without pattern (dirs)</span>
      )?
      (.*)            <span class="hljs-comment"># part containing pattern to end</span>
      $
    ///</span>
    [path, pattern] = parts[<span class="hljs-number">1.</span>.] <span class="hljs-keyword">if</span> parts.length &gt; <span class="hljs-number">1</span>
    path ?= process.cwd() <span class="hljs-comment"># make relative links absolute</span>
    path = <span class="hljs-string">"<span class="hljs-subst">#{process.cwd()}</span>/<span class="hljs-subst">#{path}</span>"</span> <span class="hljs-keyword">unless</span> path[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> <span class="hljs-string">'/'</span>
    path = fspath.resolve path
    <span class="hljs-keyword">unless</span> pattern
      <span class="hljs-keyword">return</span> fs.exists path, <span class="hljs-function"><span class="hljs-params">(exists)</span> -&gt;</span>
        <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> exists
        map = {}
        name = fspath.basename path
        name = <span class="hljs-string">"<span class="hljs-subst">#{origin.path.trim <span class="hljs-string">'/'</span>}</span>/name"</span> <span class="hljs-keyword">if</span> origin.path
        map[name] = path
        cb <span class="hljs-literal">null</span>, map</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>search with pattern</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    fs.find path,
      type: <span class="hljs-string">'f'</span>
      include: pattern
      dereference: <span class="hljs-literal">true</span>
      mindepth: path.split(<span class="hljs-regexp">/\//</span>).length - <span class="hljs-number">1</span> <span class="hljs-keyword">unless</span> pattern
      maxdepth: path.split(<span class="hljs-regexp">/\//</span>).length - <span class="hljs-number">1</span> <span class="hljs-keyword">unless</span> pattern
    , <span class="hljs-function"><span class="hljs-params">(err, list)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">if</span> err
      map = {}
      <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> list
        name = f[path.length+<span class="hljs-number">1.</span>.]
        name = <span class="hljs-string">"<span class="hljs-subst">#{origin.path.trim <span class="hljs-string">'/'</span>}</span>/name"</span> <span class="hljs-keyword">if</span> origin.path
        map[name] = f
      cb <span class="hljs-literal">null</span>, map
  , <span class="hljs-function"><span class="hljs-params">(err, results)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
    map = {}
    util.extend map, res <span class="hljs-keyword">for</span> res <span class="hljs-keyword">in</span> results
    cb <span class="hljs-literal">null</span>, map</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="validate-new-value-before-store">
  <h3>
    <a href="#validate-new-value-before-store" name="validate-new-value-before-store" class="pilcrow"></a>
Validate new value before store
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">validate = exports.validate = <span class="hljs-function"><span class="hljs-params">(config, value, cb)</span> -&gt;</span>
  debug <span class="hljs-string">"validate results"</span>
  validator.check
    name: <span class="hljs-string">'config'</span>
    value: value
    schema: config.schema
  , cb</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="loading">
  <h2>
    <a href="#loading" name="loading" class="pilcrow"></a>
Loading
  </h2>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="get-a-flat-list-of-origins">
  <h3>
    <a href="#get-a-flat-list-of-origins" name="get-a-flat-list-of-origins" class="pilcrow"></a>
Get a flat list of origins
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">listOrigins = exports.listOrigins = <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span>
  list = []
  <span class="hljs-keyword">for</span> el <span class="hljs-keyword">in</span> obj
    <span class="hljs-keyword">if</span> Array.isArray el
      list = list.concat listOrigins el
    <span class="hljs-keyword">else</span>
      list.push el
  list</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="load-origin-if-necessary">
  <h3>
    <a href="#load-origin-if-necessary" name="load-origin-if-necessary" class="pilcrow"></a>
Load origin if necessary
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">loadOrigin</span> = <span class="hljs-params">(origin, cb)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">if</span> origin.loaded
  uri = <span class="hljs-keyword">if</span> ~origin.uri.indexOf <span class="hljs-string">'://'</span> <span class="hljs-keyword">then</span> origin.uri <span class="hljs-keyword">else</span> <span class="hljs-string">'file://'</span> + origin.uri
  [proto, path] = uri.split <span class="hljs-string">'://'</span>
  <span class="hljs-keyword">switch</span> proto
    <span class="hljs-keyword">when</span> <span class="hljs-string">'file'</span>
      <span class="hljs-keyword">return</span> loadFiles origin, path, cb
    <span class="hljs-keyword">when</span> <span class="hljs-string">'http'</span>, <span class="hljs-string">'https'</span>
      <span class="hljs-keyword">return</span> loadRequest origin, uri, cb
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Unknown protocol <span class="hljs-subst">#{proto}</span>"</span>
  cb()</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="load-file-origin">
  <h3>
    <a href="#load-file-origin" name="load-file-origin" class="pilcrow"></a>
Load file origin
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">loadFiles</span> = <span class="hljs-params">(origin, path, cb)</span> -&gt;</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>find files</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  parts = path.match <span class="hljs-regexp">///
    ^
    (
      [^?*[{@]*$    <span class="hljs-comment"># everything till end without pattern</span>
    |
      [^?*[{@]*\/   <span class="hljs-comment"># everything without pattern (dirs)</span>
    )?
    (.*)            <span class="hljs-comment"># part containing pattern to end</span>
    $
  ///</span>
  [path, pattern] = parts[<span class="hljs-number">1.</span>.] <span class="hljs-keyword">if</span> parts.length &gt; <span class="hljs-number">1</span>
  path ?= process.cwd() <span class="hljs-comment"># make relative links absolute</span>
  path = <span class="hljs-string">"<span class="hljs-subst">#{process.cwd()}</span>/<span class="hljs-subst">#{path}</span>"</span> <span class="hljs-keyword">unless</span> path[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> <span class="hljs-string">'/'</span>
  path = fspath.resolve path
  <span class="hljs-keyword">unless</span> pattern
    file = path
    path = fspath.dirname path <span class="hljs-keyword">if</span> path?
    date = <span class="hljs-keyword">new</span> Date()
    <span class="hljs-keyword">return</span> loadFile origin, <span class="hljs-string">"file://<span class="hljs-subst">#{path}</span>"</span>, file, <span class="hljs-function"><span class="hljs-params">(err, result)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> err
        <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">unless</span> err.code <span class="hljs-keyword">is</span> <span class="hljs-string">'ENOENT'</span>
        debug chalk.magenta <span class="hljs-string">"Failure <span class="hljs-subst">#{err.message}</span>!"</span>
        origin.loaded = <span class="hljs-literal">true</span>
        origin.lastload = date
        <span class="hljs-keyword">return</span> cb()
      [value, meta] = result
      setOrigin origin, value, meta, date, cb
  fs.find path,
    type: <span class="hljs-string">'f'</span>
    include: pattern
    dereference: <span class="hljs-literal">true</span>
    mindepth: path.split(<span class="hljs-regexp">/\//</span>).length - <span class="hljs-number">1</span> <span class="hljs-keyword">unless</span> pattern
    maxdepth: path.split(<span class="hljs-regexp">/\//</span>).length - <span class="hljs-number">1</span> <span class="hljs-keyword">unless</span> pattern
  , <span class="hljs-function"><span class="hljs-params">(err, list)</span> -&gt;</span>
    date = <span class="hljs-keyword">new</span> Date()
    <span class="hljs-keyword">if</span> err
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">unless</span> err.code <span class="hljs-keyword">is</span> <span class="hljs-string">'ENOENT'</span>
      debug chalk.magenta <span class="hljs-string">"Failure <span class="hljs-subst">#{err.message}</span>!"</span>
      origin.loaded = <span class="hljs-literal">true</span>
      origin.lastload = date
      <span class="hljs-keyword">return</span> cb()</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>load them</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    path = <span class="hljs-string">"file:///<span class="hljs-subst">#{util.string.trim path, <span class="hljs-string">'/'</span>}</span>"</span>
    async.map list, <span class="hljs-function"><span class="hljs-params">(file, cb)</span> -&gt;</span>
      loadFile origin, path, file, cb
    , <span class="hljs-function"><span class="hljs-params">(err, objects)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>combine</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      obj = []
      meta = []
      <span class="hljs-keyword">for</span> [o, m] <span class="hljs-keyword">in</span> objects
        obj.push o
        meta.push m
      obj = util.extend.apply {}, obj
      meta = util.extend.apply {}, meta
      setOrigin origin, obj, meta, date, cb
<span class="hljs-function">
<span class="hljs-title">loadFile</span> = <span class="hljs-params">(origin, path, file, cb)</span> -&gt;</span>
  fs.readFile file,
    encoding: <span class="hljs-string">'UTF-8'</span>
  , <span class="hljs-function"><span class="hljs-params">(err, text)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>parse</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    uri = <span class="hljs-string">"file:///<span class="hljs-subst">#{util.string.trim file, <span class="hljs-string">'/'</span>}</span>"</span>
    formatter.parse text, <span class="hljs-function"><span class="hljs-params">(origin.parser ? uri)</span>, <span class="hljs-params">(err, obj)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>get additional path</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      add = uri.substring path.length+<span class="hljs-number">1</span>
      add = add[<span class="hljs-number">0.</span>.-fspath.extname(add).length<span class="hljs-number">-1</span>]
      add = add[<span class="hljs-number">0.</span>.<span class="hljs-number">-7</span>] <span class="hljs-keyword">if</span> util.string.ends add, <span class="hljs-string">'/index'</span>
      list = []
      <span class="hljs-keyword">if</span> add
        list = list.concat add.split(<span class="hljs-string">'/'</span>)[<span class="hljs-number">0.</span>.<span class="hljs-number">-2</span>] <span class="hljs-keyword">if</span> ~add.indexOf <span class="hljs-string">'/'</span>
        list.push fspath.basename add
      add = <span class="hljs-string">'/'</span> + list.join <span class="hljs-string">'/'</span> <span class="hljs-keyword">if</span> list.length</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>put object deeper</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      value = ref = {}
      <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> list
        ref[k] = {}
        ref = ref[k]
      ref[k] = v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>make meta data</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      meta = setMeta value, uri, origin
      debug <span class="hljs-string">"loaded <span class="hljs-subst">#{uri}</span>"</span>
      cb <span class="hljs-literal">null</span>, [value, meta]</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="load-file-origin-1">
  <h3>
    <a href="#load-file-origin-1" name="load-file-origin-1" class="pilcrow"></a>
Load file origin
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">loadRequest</span> = <span class="hljs-params">(origin, uri, cb)</span> -&gt;</span>
  debug <span class="hljs-string">"load   <span class="hljs-subst">#{uri}</span>"</span>
  date = <span class="hljs-keyword">new</span> Date()</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>make request</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  request ?= <span class="hljs-built_in">require</span> <span class="hljs-string">'request'</span>
  request uri, <span class="hljs-function"><span class="hljs-params">(err, response, body)</span> -&gt;</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>error checking</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
    <span class="hljs-keyword">if</span> response.statusCode <span class="hljs-keyword">isnt</span> <span class="hljs-number">200</span>
      <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Server send wrong return code: <span class="hljs-subst">#{response.statusCode}</span>"</span>
    <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> body?</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>parse content</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    formatter.parse body, <span class="hljs-function"><span class="hljs-params">(origin.parser ? uri)</span>, <span class="hljs-params">(err, obj)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      meta = setMeta obj, uri, origin
      debug <span class="hljs-string">"loaded <span class="hljs-subst">#{uri}</span>"</span>
      setOrigin origin, obj, meta, date, cb</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="set-the-extracted-information-to-the-origin-element">
  <h3>
    <a href="#set-the-extracted-information-to-the-origin-element" name="set-the-extracted-information-to-the-origin-element" class="pilcrow"></a>
Set the extracted information to the origin element
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">setOrigin</span> = <span class="hljs-params">(origin, value, meta, date, cb)</span> -&gt;</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>set filter</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">if</span> origin.filter <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> util.object.isEmpty value
    debug <span class="hljs-string">"set filter to <span class="hljs-subst">#{origin.filter}</span> in <span class="hljs-subst">#{origin.uri}</span>"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>step into data</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    res = util.object.path value, origin.filter
    <span class="hljs-keyword">if</span> res?
      value = res</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>optimize the meta list</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      filter = <span class="hljs-string">"<span class="hljs-subst">#{origin.filter}</span>/"</span>
      filter = <span class="hljs-string">"/<span class="hljs-subst">#{filter}</span>"</span> <span class="hljs-keyword">unless</span> filter[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> <span class="hljs-string">'/'</span>
      res = {}
      <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> meta</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<p>remove entries not starting with /filter/</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        <span class="hljs-keyword">continue</span> <span class="hljs-keyword">unless</span> util.string.starts k, filter</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<p>replace /filter/ with / in all meta paths</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        res[k.substring filter.length<span class="hljs-number">-1</span>] = v
      meta = res
    <span class="hljs-keyword">else</span>
      debug chalk.red <span class="hljs-string">"Could not set filter <span class="hljs-subst">#{origin.filter}</span> in <span class="hljs-subst">#{origin.uri}</span>"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35"></a>
</div>
<p>set specific path</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">if</span> origin.path
    debug <span class="hljs-string">"set under path <span class="hljs-subst">#{origin.path}</span> for <span class="hljs-subst">#{origin.uri}</span>"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36"></a>
</div>
<p>add path to value</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    path = util.string.trim origin.path, <span class="hljs-string">'/'</span>
    obj = ref = {}
    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> path.split <span class="hljs-string">'/'</span>
      ref[k] = {}
      ref = ref[k]
    ref[k] = v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> value
    value = obj</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37"></a>
</div>
<p>add path to meta</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    ref = {}
    ref[<span class="hljs-string">"/<span class="hljs-subst">#{path}</span>/<span class="hljs-subst">#{k}</span>"</span>] = v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> meta
    meta = ref</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38"></a>
</div>
<p>store in origin</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  origin.value = value
  origin.meta = meta
  origin.lastload = date
  debug <span class="hljs-string">"loaded <span class="hljs-subst">#{origin.path ? <span class="hljs-string">'ROOT'</span>}</span> with: \n
</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39"></a>
</div>
<p>{ chalk.grey util.inspect origin.value, {depth: null}}&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  cb()</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="set-meta-data-to-all-elements">
  <h3>
    <a href="#set-meta-data-to-all-elements" name="set-meta-data-to-all-elements" class="pilcrow"></a>
Set Meta Data to all elements
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">setMeta</span> = <span class="hljs-params">(obj, uri, origin, prefix=<span class="hljs-string">''</span>)</span> -&gt;</span>
  meta = {}
  <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
    path = <span class="hljs-string">"<span class="hljs-subst">#{prefix}</span>/<span class="hljs-subst">#{k}</span>"</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> v <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span>
      <span class="hljs-keyword">for</span> key, val <span class="hljs-keyword">of</span> setMeta v, uri, origin, path
        meta[key] = val
    <span class="hljs-keyword">else</span>
      meta[path] = [
        uri: uri
        origin: origin
        value: v
      ]
  <span class="hljs-keyword">return</span> meta</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
