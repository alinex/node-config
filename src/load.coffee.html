<!DOCTYPE html>
<html>
<head>
  <title>load.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "home/alex/github/node-config/src/load.coffee";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0" /></head>
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io"
  onmouseover="logo.src='https://alinex.github.io/images/Alinex-200.png'"
  onmouseout="logo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="logo" src="https://alinex.github.io/images/Alinex-black-200.png"
    width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png"
    style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog"
    class="btn btn-primary"><span class="glyphicon-pencil"></span> Blog</a>
  <a href="http://alinex.github.io/develop"
    class="btn btn-primary"><span class="glyphicon-book"></span> Develop</a>
  <a href="http://alinex.github.io/code.html"
    class="btn btn-warning"><span class="glyphicon-cog"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#configuration">Configuration</a>
      </div>

      <div class="heading h2">
        <a href="#architecture">Architecture</a>
      </div>

      <div class="heading h2">
        <a href="#node-modules">Node Modules</a>
      </div>

      <div class="heading h2">
        <a href="#initialize-origins">Initialize origins</a>
      </div>

      <div class="heading h3">
        <a href="#validate-new-value-before-store">Validate new value before store</a>
      </div>

      <div class="heading h2">
        <a href="#loading">Loading</a>
      </div>

      <div class="heading h3">
        <a href="#get-a-flat-list-of-origins">Get a flat list of origins</a>
      </div>

      <div class="heading h3">
        <a href="#load-origin-if-necessary">Load origin if necessary</a>
      </div>

      <div class="heading h3">
        <a href="#load-file-origin">Load file origin</a>
      </div>

      <div class="heading h3">
        <a href="#load-file-origin-1">Load file origin</a>
      </div>

      <div class="heading h3">
        <a href="#set-the-extracted-information-to-the-origin-element">Set the extracted information to the origin element</a>
      </div>

      <div class="heading h3">
        <a href="#parse-text-into-object">Parse text into object</a>
      </div>

      <div class="heading h3">
        <a href="#parse-given-format">Parse given Format</a>
      </div>

      <div class="heading h3">
        <a href="#optimize-parsed-cml">Optimize parsed cml</a>
      </div>

      <div class="heading h3">
        <a href="#check-that-the-properties-parser-for-correct-result">Check that the properties parser for correct result</a>
      </div>

      <div class="heading h3">
        <a href="#set-meta-data-to-all-elements">Set Meta Data to all elements</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-config" title="Fork me on GitHub"></a>
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="configuration">
  <h1>
    <a href="#configuration" name="configuration" class="pilcrow"></a>
Configuration
  </h1>
</div>
<p>This package will give you an easy way to load and use configuration settings
into your application or module.</p>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="architecture">
  <h2>
    <a href="#architecture" name="architecture" class="pilcrow"></a>
Architecture
  </h2>
</div>
<p>The configuration handling consists of a singleton class as central information
storage like a registry. On access you will get references to the data.</p>
<p>A special behavior is the reloading of the configuration after the files
changed. This is done using a watcher on the file search path which will
automatically load all configurations which are changed into the class cache.
Through class events the instances will get informed if anything changed, so
they can reload their data and emit events for their application listeners
to update this data, too.</p>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="node-modules">
  <h2>
    <a href="#node-modules" name="node-modules" class="pilcrow"></a>
Node Modules
  </h2>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>include base modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'config:load'</span>)
chalk = <span class="hljs-built_in">require</span> <span class="hljs-string">'chalk'</span>
util = <span class="hljs-built_in">require</span> <span class="hljs-string">'util'</span>
fspath = <span class="hljs-built_in">require</span> <span class="hljs-string">'path'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>include more alinex modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">fs = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-fs'</span>
async = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-async'</span>
{string, object} = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-util'</span>
validator = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-validator'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="initialize-origins">
  <h2>
    <a href="#initialize-origins" name="initialize-origins" class="pilcrow"></a>
Initialize origins
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">
exports.init = <span class="hljs-function"><span class="hljs-params">(config, cb)</span> -&gt;</span>
  debug <span class="hljs-string">"load all unloaded configurations"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>step through origins</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  origins = listOrigins config.origin
  async.each origins, loadOrigin, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>combine all</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    value = {}
    meta = {}
    <span class="hljs-keyword">for</span> origin <span class="hljs-keyword">in</span> origins</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>put together</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      object.extend value, origin.value
      object.extendArrayConcat meta, origin.meta</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>validate</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    validate config, value, <span class="hljs-function"><span class="hljs-params">(err, value)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>set</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      config.value = value
      config.meta = meta
      cb()</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="validate-new-value-before-store">
  <h3>
    <a href="#validate-new-value-before-store" name="validate-new-value-before-store" class="pilcrow"></a>
Validate new value before store
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">validate = exports.validate = <span class="hljs-function"><span class="hljs-params">(config, value, cb)</span> -&gt;</span>
  debug <span class="hljs-string">"validate results"</span>
  validator.check
    <span class="hljs-attribute">name</span>: <span class="hljs-string">'config'</span>
    <span class="hljs-attribute">value</span>: value
    <span class="hljs-attribute">schema</span>: config.schema
  , cb</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="loading">
  <h2>
    <a href="#loading" name="loading" class="pilcrow"></a>
Loading
  </h2>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="get-a-flat-list-of-origins">
  <h3>
    <a href="#get-a-flat-list-of-origins" name="get-a-flat-list-of-origins" class="pilcrow"></a>
Get a flat list of origins
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">listOrigins = exports.listOrigins = <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span>
  list = []
  <span class="hljs-keyword">for</span> el <span class="hljs-keyword">in</span> obj
    <span class="hljs-keyword">if</span> Array.isArray el
      list = list.concat listOrigins el
    <span class="hljs-keyword">else</span>
      list.push el
  list</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="load-origin-if-necessary">
  <h3>
    <a href="#load-origin-if-necessary" name="load-origin-if-necessary" class="pilcrow"></a>
Load origin if necessary
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">loadOrigin</span> = <span class="hljs-params">(origin, cb)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">if</span> origin.loaded
  uri = <span class="hljs-keyword">if</span> ~origin.uri.indexOf <span class="hljs-string">'://'</span> <span class="hljs-keyword">then</span> origin.uri <span class="hljs-keyword">else</span> <span class="hljs-string">'file://'</span> + origin.uri
  [proto, path] = uri.split <span class="hljs-string">'://'</span>
  <span class="hljs-keyword">switch</span> proto
    <span class="hljs-keyword">when</span> <span class="hljs-string">'file'</span>
      <span class="hljs-keyword">return</span> loadFiles origin, path, cb
    <span class="hljs-keyword">when</span> <span class="hljs-string">'http'</span>, <span class="hljs-string">'https'</span>
      <span class="hljs-keyword">return</span> loadRequest origin, uri, cb
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Unknown protocol <span class="hljs-subst">#{proto}</span>"</span>
  cb()</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="load-file-origin">
  <h3>
    <a href="#load-file-origin" name="load-file-origin" class="pilcrow"></a>
Load file origin
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">loadFiles</span> = <span class="hljs-params">(origin, path, cb)</span> -&gt;</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>find files</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  parts = path.match <span class="hljs-regexp">///
    ^
    (
      [^?*[{@]*$    <span class="hljs-comment"># everything till end without pattern</span>
    |
      [^?*[{@]*\/   <span class="hljs-comment"># everything without pattern (dirs)</span>
    )?
    (.*)            <span class="hljs-comment"># part containing pattern to end</span>
    $
  ///</span>
  [path, pattern] = parts[<span class="hljs-number">1.</span>.] <span class="hljs-keyword">if</span> parts.length &gt; <span class="hljs-number">1</span>
  path ?= process.cwd() <span class="hljs-comment"># make relative links absolute</span>
  path = <span class="hljs-string">"<span class="hljs-subst">#{process.cwd()}</span>/<span class="hljs-subst">#{path}</span>"</span> <span class="hljs-keyword">unless</span> path[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> <span class="hljs-string">'/'</span>
  path = fspath.resolve path
  <span class="hljs-keyword">unless</span> pattern
    file = path
    path = fspath.dirname path <span class="hljs-keyword">if</span> path?
    date = <span class="hljs-keyword">new</span> Date()
    <span class="hljs-keyword">return</span> loadFile origin, <span class="hljs-string">"file://<span class="hljs-subst">#{path}</span>"</span>, file, <span class="hljs-function"><span class="hljs-params">(err, result)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> err
        <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">unless</span> err.code <span class="hljs-keyword">is</span> <span class="hljs-string">'ENOENT'</span>
        debug chalk.magenta <span class="hljs-string">"Failure <span class="hljs-subst">#{err.message}</span>!"</span>
        origin.loaded = <span class="hljs-literal">true</span>
        origin.lastload = date
        <span class="hljs-keyword">return</span> cb()
      [value, meta] = result
      setOrigin origin, value, meta, date, cb
  fs.find path,
    <span class="hljs-attribute">type</span>: <span class="hljs-string">'f'</span>
    <span class="hljs-attribute">include</span>: pattern
    <span class="hljs-attribute">dereference</span>: <span class="hljs-literal">true</span>
    <span class="hljs-attribute">mindepth</span>: path.split(<span class="hljs-regexp">/\//</span>).length - <span class="hljs-number">1</span> <span class="hljs-keyword">unless</span> pattern
    <span class="hljs-attribute">maxdepth</span>: path.split(<span class="hljs-regexp">/\//</span>).length - <span class="hljs-number">1</span> <span class="hljs-keyword">unless</span> pattern
  , <span class="hljs-function"><span class="hljs-params">(err, list)</span> -&gt;</span>
    date = <span class="hljs-keyword">new</span> Date()
    <span class="hljs-keyword">if</span> err
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">unless</span> err.code <span class="hljs-keyword">is</span> <span class="hljs-string">'ENOENT'</span>
      debug chalk.magenta <span class="hljs-string">"Failure <span class="hljs-subst">#{err.message}</span>!"</span>
      origin.loaded = <span class="hljs-literal">true</span>
      origin.lastload = date
      <span class="hljs-keyword">return</span> cb()</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>load them</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    path = <span class="hljs-string">"file:///<span class="hljs-subst">#{string.trim path, <span class="hljs-string">'/'</span>}</span>"</span>
    async.map list, <span class="hljs-function"><span class="hljs-params">(file, cb)</span> -&gt;</span>
      loadFile origin, path, file, cb
    , <span class="hljs-function"><span class="hljs-params">(err, objects)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>combine</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      obj = []
      meta = []
      <span class="hljs-keyword">for</span> [o, m] <span class="hljs-keyword">in</span> objects
        obj.push o
        meta.push m
      obj = object.extend.apply {}, obj
      meta = object.extendArrayConcat.apply {}, meta
      setOrigin origin, obj, meta, date, cb
<span class="hljs-function">
<span class="hljs-title">loadFile</span> = <span class="hljs-params">(origin, path, file, cb)</span> -&gt;</span>
  fs.readFile file,
    <span class="hljs-attribute">encoding</span>: <span class="hljs-string">'UTF-8'</span>
  , <span class="hljs-function"><span class="hljs-params">(err, text)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>parse</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    uri = <span class="hljs-string">"file:///<span class="hljs-subst">#{string.trim file, <span class="hljs-string">'/'</span>}</span>"</span>
    parse text, uri, origin.parser, <span class="hljs-literal">false</span>, <span class="hljs-function"><span class="hljs-params">(err, obj)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>get additional path</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      add = uri.substring path.length+<span class="hljs-number">1</span>
      add = add[<span class="hljs-number">0.</span>.-fspath.extname(add).length-<span class="hljs-number">1</span>]
      add = add[<span class="hljs-number">0.</span>.-<span class="hljs-number">7</span>] <span class="hljs-keyword">if</span> string.ends add, <span class="hljs-string">'/index'</span>
      list = []
      <span class="hljs-keyword">if</span> add
        list = list.concat add.split(<span class="hljs-string">'/'</span>)[<span class="hljs-number">0.</span>.-<span class="hljs-number">2</span>] <span class="hljs-keyword">if</span> ~add.indexOf <span class="hljs-string">'/'</span>
        list.push fspath.basename add
      add = <span class="hljs-string">'/'</span> + list.join <span class="hljs-string">'/'</span> <span class="hljs-keyword">if</span> list.length</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>put object deeper</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      value = ref = {}
      <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> list
        ref[k] = {}
        ref = ref[k]
      ref[k] = v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>make meta data</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      meta = setMeta value, uri, origin
      debug <span class="hljs-string">"loaded <span class="hljs-subst">#{uri}</span>"</span>
      cb <span class="hljs-literal">null</span>, [value, meta]</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="load-file-origin-1">
  <h3>
    <a href="#load-file-origin-1" name="load-file-origin-1" class="pilcrow"></a>
Load file origin
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">loadRequest</span> = <span class="hljs-params">(origin, uri, cb)</span> -&gt;</span>
  debug <span class="hljs-string">"load   <span class="hljs-subst">#{uri}</span>"</span>
  date = <span class="hljs-keyword">new</span> Date()</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>make request</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  request = <span class="hljs-built_in">require</span> <span class="hljs-string">'request'</span>
  request uri, <span class="hljs-function"><span class="hljs-params">(err, response, body)</span> -&gt;</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>error checking</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
    <span class="hljs-keyword">if</span> response.statusCode <span class="hljs-keyword">isnt</span> <span class="hljs-number">200</span>
      <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Server send wrong return code: <span class="hljs-subst">#{response.statusCode}</span>"</span>
    <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> body?</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>parse content</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    parse body, uri, origin.parser, <span class="hljs-literal">false</span>, <span class="hljs-function"><span class="hljs-params">(err, obj)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      meta = setMeta obj, uri, origin
      debug <span class="hljs-string">"loaded <span class="hljs-subst">#{uri}</span>"</span>
      setOrigin origin, obj, meta, date, cb</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="set-the-extracted-information-to-the-origin-element">
  <h3>
    <a href="#set-the-extracted-information-to-the-origin-element" name="set-the-extracted-information-to-the-origin-element" class="pilcrow"></a>
Set the extracted information to the origin element
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">setOrigin</span> = <span class="hljs-params">(origin, value, meta, date, cb)</span> -&gt;</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<p>set filter</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">if</span> origin.filter <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> object.isEmpty value
    debug <span class="hljs-string">"set filter to <span class="hljs-subst">#{origin.filter}</span> in <span class="hljs-subst">#{origin.uri}</span>"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>step into data</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    res = object.path value, origin.filter
    <span class="hljs-keyword">if</span> res?
      value = res</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>optimize the meta list</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      filter = <span class="hljs-string">"<span class="hljs-subst">#{origin.filter}</span>/"</span>
      filter = <span class="hljs-string">"/<span class="hljs-subst">#{filter}</span>"</span> <span class="hljs-keyword">unless</span> filter[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> <span class="hljs-string">'/'</span>
      res = {}
      <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> meta</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>remove entries not starting with /filter/</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        <span class="hljs-keyword">continue</span> <span class="hljs-keyword">unless</span> string.starts k, filter</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<p>replace /filter/ with / in all meta paths</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        res[k.substring filter.length-<span class="hljs-number">1</span>] = v
      meta = res
    <span class="hljs-keyword">else</span>
      debug chalk.red <span class="hljs-string">"Could not set filter <span class="hljs-subst">#{origin.filter}</span> in <span class="hljs-subst">#{origin.uri}</span>"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<p>set specific path</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">if</span> origin.path
    debug <span class="hljs-string">"set under path <span class="hljs-subst">#{origin.path}</span> for <span class="hljs-subst">#{origin.uri}</span>"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35"></a>
</div>
<p>add path to value</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    path = string.trim origin.path, <span class="hljs-string">'/'</span>
    obj = ref = {}
    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> path.split <span class="hljs-string">'/'</span>
      ref[k] = {}
      ref = ref[k]
    ref[k] = v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> value
    value = obj</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36"></a>
</div>
<p>add path to meta</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    ref = {}
    ref[<span class="hljs-string">"/<span class="hljs-subst">#{path}</span>/<span class="hljs-subst">#{k}</span>"</span>] = v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> meta
    meta = ref</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37"></a>
</div>
<p>store in origin</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  origin.value = value
  origin.meta = meta
  origin.lastload = date
  debug <span class="hljs-string">"loaded <span class="hljs-subst">#{origin.path ? <span class="hljs-string">'ROOT'</span>}</span> with: \n
</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38"></a>
</div>
<p>{ chalk.grey util.inspect origin.value, {depth: null}}&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  cb()

ext2parser =
  <span class="hljs-attribute">yml</span>: <span class="hljs-string">'yaml'</span>
  <span class="hljs-attribute">yaml</span>: <span class="hljs-string">'yaml'</span>
  <span class="hljs-attribute">js</span>: <span class="hljs-string">'js'</span>
  <span class="hljs-attribute">javascript</span>: <span class="hljs-string">'javascript'</span>
  <span class="hljs-attribute">json</span>: <span class="hljs-string">'json'</span>
  <span class="hljs-attribute">cson</span>: <span class="hljs-string">'coffee'</span>
  <span class="hljs-attribute">coffee</span>: <span class="hljs-string">'coffee'</span>
  <span class="hljs-attribute">xml</span>: <span class="hljs-string">'xml'</span>
  <span class="hljs-attribute">ini</span>: <span class="hljs-string">'ini'</span>
  <span class="hljs-attribute">properties</span>: <span class="hljs-string">'properties'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="parse-text-into-object">
  <h3>
    <a href="#parse-text-into-object" name="parse-text-into-object" class="pilcrow"></a>
Parse text into object
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">parse</span> = <span class="hljs-params">(text, uri, parser, quiet=<span class="hljs-literal">false</span>, cb)</span> -&gt;</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40"></a>
</div>
<p>auto detection</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  list = [<span class="hljs-string">'xml'</span>, <span class="hljs-string">'ini'</span>, <span class="hljs-string">'properties'</span>, <span class="hljs-string">'coffee'</span>, <span class="hljs-string">'yaml'</span>, <span class="hljs-string">'json'</span>, <span class="hljs-string">'js'</span>]
  <span class="hljs-keyword">unless</span> parser <span class="hljs-keyword">in</span> list
    detect = list[<span class="hljs-number">0.</span>.]
    ext = fspath.extname(uri).substring <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> type = ext2parser[ext]
      i = detect.indexOf type
      detect.splice i, <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> i &gt; -<span class="hljs-number">1</span>
      detect.unshift type
    result = <span class="hljs-literal">null</span>
    errors = []
    async.detectSeries detect, <span class="hljs-function"><span class="hljs-params">(type, cb)</span> -&gt;</span>
      parseFormat text, uri, type, <span class="hljs-literal">true</span>, <span class="hljs-function"><span class="hljs-params">(err, obj)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> err
          errors.push err.message
          debug chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{uri}</span> failed in <span class="hljs-subst">#{err.message}</span>"</span>
        result = obj
        cb <span class="hljs-keyword">not</span> err? <span class="hljs-keyword">and</span> obj?
    , <span class="hljs-function"><span class="hljs-params">(ok)</span> -&gt;</span>
      <span class="hljs-keyword">unless</span> ok
        <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Could not find any valid format for <span class="hljs-subst">#{uri}</span>:\n<span class="hljs-subst">#{errors.join <span class="hljs-string">'\n'</span>}</span>"</span>
      cb <span class="hljs-literal">null</span>, result
    <span class="hljs-keyword">return</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41"></a>
</div>
<p>parse direct given format only</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  parseFormat text, uri, parser, quiet, <span class="hljs-function"><span class="hljs-params">(err, result)</span> -&gt;</span>
    err = <span class="hljs-keyword">new</span> Error <span class="hljs-string">"<span class="hljs-subst">#{uri}</span> failed in <span class="hljs-subst">#{err.message}</span>"</span> <span class="hljs-keyword">if</span> err
    cb err, result</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="parse-given-format">
  <h3>
    <a href="#parse-given-format" name="parse-given-format" class="pilcrow"></a>
Parse given Format
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">parseFormat</span> =  <span class="hljs-params">(text, uri, parser, quiet=<span class="hljs-literal">false</span>, cb)</span> -&gt;</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43"></a>
</div>
<p>parse specified format</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  color = <span class="hljs-keyword">if</span> quiet <span class="hljs-keyword">then</span> <span class="hljs-string">'grey'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'red'</span>
  debug chalk.grey <span class="hljs-string">"try loading <span class="hljs-subst">#{uri}</span> as <span class="hljs-subst">#{parser}</span>"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44"></a>
</div>
<p>parser given</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">switch</span> parser
    <span class="hljs-keyword">when</span> <span class="hljs-string">'yaml'</span>
      yaml = <span class="hljs-built_in">require</span> <span class="hljs-string">'js-yaml'</span>
      <span class="hljs-keyword">try</span>
        result = yaml.safeLoad text
      <span class="hljs-keyword">catch</span> error
        error.message = error.message.replace <span class="hljs-string">'JS-YAML: '</span>, <span class="hljs-string">''</span>
        <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error chalk[color] <span class="hljs-string">"<span class="hljs-subst">#{parser}</span> parser: <span class="hljs-subst">#{error.message.replace <span class="hljs-regexp">/[\s^]+/g</span>, <span class="hljs-string">' '</span>}</span>"</span>
      cb <span class="hljs-literal">null</span>, result
    <span class="hljs-keyword">when</span> <span class="hljs-string">'js'</span>
      vm = <span class="hljs-built_in">require</span> <span class="hljs-string">'vm'</span>
      <span class="hljs-keyword">try</span>
        result = vm.runInNewContext <span class="hljs-string">"x=<span class="hljs-subst">#{text}</span>"</span>
      <span class="hljs-keyword">catch</span> error
        <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error chalk[color] <span class="hljs-string">"<span class="hljs-subst">#{parser}</span> parser: <span class="hljs-subst">#{error.message}</span>"</span>
      cb <span class="hljs-literal">null</span>, result
    <span class="hljs-keyword">when</span> <span class="hljs-string">'json'</span>
      <span class="hljs-keyword">try</span>
        result = JSON.parse text
      <span class="hljs-keyword">catch</span> error
        <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error chalk[color] <span class="hljs-string">"<span class="hljs-subst">#{parser}</span> parser: <span class="hljs-subst">#{error.message}</span>"</span>
      cb <span class="hljs-literal">null</span>, result
    <span class="hljs-keyword">when</span> <span class="hljs-string">'coffee'</span>
      coffee = <span class="hljs-built_in">require</span> <span class="hljs-string">'coffee-script'</span>
      <span class="hljs-keyword">try</span>
        text = <span class="hljs-string">"module.exports =\n  "</span> + text.replace <span class="hljs-regexp">/\n/g</span>, <span class="hljs-string">'\n  '</span>
        m = <span class="hljs-keyword">new</span> <span class="hljs-built_in">module</span>.constructor()
        m._compile coffee.compile(text), uri
      <span class="hljs-keyword">catch</span> error
        <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error chalk[color] <span class="hljs-string">"<span class="hljs-subst">#{parser}</span> parser: <span class="hljs-subst">#{error.message}</span>"</span>
      cb <span class="hljs-literal">null</span>, m.exports
    <span class="hljs-keyword">when</span> <span class="hljs-string">'properties'</span>
      properties = <span class="hljs-built_in">require</span> <span class="hljs-string">'properties'</span>
      properties.parse text,
        <span class="hljs-attribute">sections</span>: <span class="hljs-literal">true</span>
        <span class="hljs-attribute">namespaces</span>: <span class="hljs-literal">true</span>
      , <span class="hljs-function"><span class="hljs-params">(err, result)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> err
          <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error chalk[color] <span class="hljs-string">"<span class="hljs-subst">#{parser}</span> parser: <span class="hljs-subst">#{err.message}</span>"</span>
        <span class="hljs-keyword">unless</span> propertiesCheck result
          <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error chalk[color] <span class="hljs-string">"<span class="hljs-subst">#{parser}</span> parser: Unexpected characters []{}/
          in key name found"</span>
        cb <span class="hljs-literal">null</span>, result
    <span class="hljs-keyword">when</span> <span class="hljs-string">'ini'</span>
      ini = <span class="hljs-built_in">require</span> <span class="hljs-string">'ini'</span>
      <span class="hljs-keyword">try</span>
        result = ini.decode text
      <span class="hljs-keyword">catch</span> error
        <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error chalk[color] <span class="hljs-string">"<span class="hljs-subst">#{parser}</span> parser: <span class="hljs-subst">#{error.message}</span>"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45"></a>
</div>
<p>detect failed parsing</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> result?
        <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error chalk[color] <span class="hljs-string">"<span class="hljs-subst">#{parser}</span> parser: could not parse any result"</span>
      <span class="hljs-keyword">if</span> result[<span class="hljs-string">'{'</span>]
        <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error chalk[color] <span class="hljs-string">"<span class="hljs-subst">#{parser}</span> parser: Unexpected token { at start"</span>
      <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> result
        <span class="hljs-keyword">if</span> v <span class="hljs-keyword">is</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">and</span> k.match <span class="hljs-regexp">/:/</span>
          <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error chalk[color] <span class="hljs-string">"<span class="hljs-subst">#{parser}</span> parser: Unexpected key name containing
          ':' with value true"</span>
      cb <span class="hljs-literal">null</span>, result
    <span class="hljs-keyword">when</span> <span class="hljs-string">'xml'</span>
      xml2js = <span class="hljs-built_in">require</span> <span class="hljs-string">'xml2js'</span>
      xml2js.parseString text, {<span class="hljs-attribute">explicitArray</span>: <span class="hljs-literal">false</span>}, <span class="hljs-function"><span class="hljs-params">(err, result)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> err
          <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error chalk[color] <span class="hljs-string">"<span class="hljs-subst">#{parser}</span> parser: <span class="hljs-subst">#{err.message.replace <span class="hljs-regexp">/\n/g</span>, <span class="hljs-string">' '</span>}</span>"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46"></a>
</div>
<p>optimize result of attributes</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        cb <span class="hljs-literal">null</span>, xmlOptimize result
    <span class="hljs-keyword">else</span>
      cb <span class="hljs-keyword">new</span> Error chalk[color] <span class="hljs-string">"Parser for <span class="hljs-subst">#{parser}</span> not found"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="optimize-parsed-cml">
  <h3>
    <a href="#optimize-parsed-cml" name="optimize-parsed-cml" class="pilcrow"></a>
Optimize parsed cml
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">xmlOptimize</span> = <span class="hljs-params">(data)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> data <span class="hljs-keyword">unless</span> <span class="hljs-keyword">typeof</span> data <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span>
  <span class="hljs-keyword">if</span> Array.isArray data</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48"></a>
</div>
<p>seep analyze array</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    result = []
    <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> data
      result.push xmlOptimize v
    <span class="hljs-keyword">return</span> result
  result = {}
  <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> data</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49"></a>
</div>
<p>set value</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">if</span> k <span class="hljs-keyword">is</span> <span class="hljs-string">'_'</span>
      result.value = v</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50"></a>
</div>
<p>set attributes</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> k <span class="hljs-keyword">is</span> <span class="hljs-string">'$'</span>
      <span class="hljs-keyword">for</span> s, w <span class="hljs-keyword">of</span> xmlOptimize v
        result[s] = w</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51"></a>
</div>
<p>keep other but check contents</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">else</span>
      result[k] = xmlOptimize v
  <span class="hljs-keyword">return</span> result</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="check-that-the-properties-parser-for-correct-result">
  <h3>
    <a href="#check-that-the-properties-parser-for-correct-result" name="check-that-the-properties-parser-for-correct-result" class="pilcrow"></a>
Check that the properties parser for correct result
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">propertiesCheck</span> = <span class="hljs-params">(data)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">unless</span> <span class="hljs-keyword">typeof</span> data <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span>
  <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> data
    <span class="hljs-keyword">if</span> v <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">or</span> ~<span class="hljs-string">'[]{}/'</span>.indexOf k.charAt <span class="hljs-number">0</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">unless</span> propertiesCheck v
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="set-meta-data-to-all-elements">
  <h3>
    <a href="#set-meta-data-to-all-elements" name="set-meta-data-to-all-elements" class="pilcrow"></a>
Set Meta Data to all elements
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">setMeta</span> = <span class="hljs-params">(obj, uri, origin, prefix=<span class="hljs-string">''</span>)</span> -&gt;</span>
  meta = {}
  <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
    path = <span class="hljs-string">"<span class="hljs-subst">#{prefix}</span>/<span class="hljs-subst">#{k}</span>"</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> v <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span>
      <span class="hljs-keyword">for</span> key, val <span class="hljs-keyword">of</span> setMeta v, uri, origin, path
        meta[key] = val
    <span class="hljs-keyword">else</span>
      meta[path] = [
        <span class="hljs-attribute">uri</span>: uri
        <span class="hljs-attribute">origin</span>: origin
        <span class="hljs-attribute">value</span>: v
      ]
  <span class="hljs-keyword">return</span> meta</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
