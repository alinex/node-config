<!DOCTYPE html>
<html>
<head>
  <title>load.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../", thisFile = "home/alex/a3/node-config/src/loadcoffee", defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>
  <script src="../fileSearch.js"></script>
  <script src="../goToLine.js"></script>
  <link rel="stylesheet" href="../fileSearch.css" />
  <link rel="stylesheet" href="../goToLine.css" />
</head>
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io" onmouseover="lllogo.src='https://alinex.github.io/images/Alinex-200.png'" onmouseout="lllogo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="lllogo" src="https://alinex.github.io/images/Alinex-black-200.png" width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png" style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog" class="btn btn-primary"><span class="glyphicon-cog"></span> Blog</a>
  <a href="http://alinex.github.io/code.html" class="btn btn-warning"><span class="glyphicon-pencil"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h1">
        <a href="#configuration">Configuration</a>
      </div>
      <div class="heading h2">
        <a href="#architecture">Architecture</a>
      </div>
      <div class="heading h2">
        <a href="#node%20modules">Node Modules</a>
      </div>
      <div class="heading h2">
        <a href="#initialize%20origins">Initialize origins</a>
      </div>
      <div class="heading h3">
        <a href="#validate%20new%20value%20before%20store">Validate new value before store</a>
      </div>
      <div class="heading h2">
        <a href="#loading">Loading</a>
      </div>
      <div class="heading h3">
        <a href="#get%20a%20flat%20list%20of%20origins">Get a flat list of origins</a>
      </div>
      <div class="heading h3">
        <a href="#load%20origin%20if%20necessary">Load origin if necessary</a>
      </div>
      <div class="heading h3">
        <a href="#load%20file%20origin">Load file origin</a>
      </div>
      <div class="heading h3">
        <a href="#load%20file%20origin">Load file origin</a>
      </div>
      <div class="heading h3">
        <a href="#set%20the%20extracted%20information%20to%20the%20origin%20element">Set the extracted information to the origin element</a>
      </div>
      <div class="heading h3">
        <a href="#parse%20text%20into%20object">Parse text into object</a>
      </div>
      <div class="heading h3">
        <a href="#parse%20given%20format">Parse given Format</a>
      </div>
      <div class="heading h3">
        <a href="#optimize%20parsed%20cml">Optimize parsed cml</a>
      </div>
      <div class="heading h3">
        <a href="#check%20that%20the%20properties%20parser%20for%20correct%20result">Check that the properties parser for correct result</a>
      </div>
      <div class="heading h3">
        <a href="#set%20meta%20data%20to%20all%20elements">Set Meta Data to all elements</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-config" title="Fork me on GitHub"></a><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
<div class="pilwrap" id="configuration">
  <h1>
    <a href="#configuration" name="configuration" class="pilcrow">&#182;</a>
    Configuration
  </h1>
</div>


<p>This package will give you an easy way to load and use configuration settings
into your application or module.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="architecture">
  <h2>
    <a href="#architecture" name="architecture" class="pilcrow">&#182;</a>
    Architecture
  </h2>
</div>


<p>The configuration handling consists of a singleton class as central information
storage like a registry. On access you will get references to the data.</p>

<p>A special behavior is the reloading of the configuration after the files
changed. This is done using a watcher on the file search path which will
automatically load all configurations which are changed into the class cache.
Through class events the instances will get informed if anything changed, so
they can reload their data and emit events for their application listeners
to update this data, too.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="node%20modules">
  <h2>
    <a href="#node%20modules" name="node%20modules" class="pilcrow">&#182;</a>
    Node Modules
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>include base modules</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">debug = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;debug&#39;</span><span class="p">)(</span><span class="s">&#39;config:load&#39;</span><span class="p">)</span>
<span class="nv">chalk = </span><span class="nx">require</span> <span class="s">&#39;chalk&#39;</span>
<span class="nv">util = </span><span class="nx">require</span> <span class="s">&#39;util&#39;</span>
<span class="nv">fspath = </span><span class="nx">require</span> <span class="s">&#39;path&#39;</span>
<span class="nv">chokidar = </span><span class="nx">require</span> <span class="s">&#39;chokidar&#39;</span>
<span class="nv">EventEmitter = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;events&#39;</span><span class="p">).</span><span class="nx">EventEmitter</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>include more alinex modules</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">fs = </span><span class="nx">require</span> <span class="s">&#39;alinex-fs&#39;</span>
<span class="nv">async = </span><span class="nx">require</span> <span class="s">&#39;alinex-async&#39;</span>
<span class="p">{</span><span class="nx">string</span><span class="p">,</span> <span class="nx">object</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&#39;alinex-util&#39;</span>
<span class="nv">validator = </span><span class="nx">require</span> <span class="s">&#39;alinex-validator&#39;</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="initialize%20origins">
  <h2>
    <a href="#initialize%20origins" name="initialize%20origins" class="pilcrow">&#182;</a>
    Initialize origins
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nv">exports.init = </span><span class="nf">(config, cb) -&gt;</span>
  <span class="nx">debug</span> <span class="s">&quot;load all unloaded configurations&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>step through origins</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">origins = </span><span class="nx">listOrigins</span> <span class="nx">config</span><span class="p">.</span><span class="nx">origin</span>
  <span class="nx">async</span><span class="p">.</span><span class="nx">each</span> <span class="nx">origins</span><span class="p">,</span> <span class="nx">loadOrigin</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
    <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>combine all</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">value = </span><span class="p">{}</span>
    <span class="nv">meta = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">origin</span> <span class="k">in</span> <span class="nx">origins</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>put together</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">object</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">value</span>
      <span class="nx">object</span><span class="p">.</span><span class="nx">extendArrayConcat</span> <span class="nx">meta</span><span class="p">,</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">meta</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>validate</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">validate</span> <span class="nx">config</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nf">(err, value) -&gt;</span>
      <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>set</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nv">config.value = </span><span class="nx">value</span>
      <span class="nv">config.meta = </span><span class="nx">meta</span>
      <span class="nx">cb</span><span class="p">()</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="validate%20new%20value%20before%20store">
  <h3>
    <a href="#validate%20new%20value%20before%20store" name="validate%20new%20value%20before%20store" class="pilcrow">&#182;</a>
    Validate new value before store
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">validate = exports.validate = </span><span class="nf">(config, value, cb) -&gt;</span>
  <span class="nx">debug</span> <span class="s">&quot;validate results&quot;</span>
  <span class="nx">validator</span><span class="p">.</span><span class="nx">check</span>
    <span class="nv">name: </span><span class="s">&#39;config&#39;</span>
    <span class="nv">value: </span><span class="nx">value</span>
    <span class="nv">schema: </span><span class="nx">config</span><span class="p">.</span><span class="nx">schema</span>
  <span class="p">,</span> <span class="nx">cb</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="loading">
  <h2>
    <a href="#loading" name="loading" class="pilcrow">&#182;</a>
    Loading
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="get%20a%20flat%20list%20of%20origins">
  <h3>
    <a href="#get%20a%20flat%20list%20of%20origins" name="get%20a%20flat%20list%20of%20origins" class="pilcrow">&#182;</a>
    Get a flat list of origins
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">listOrigins = exports.listOrigins = </span><span class="nf">(obj) -&gt;</span>
  <span class="nv">list = </span><span class="p">[]</span>
  <span class="k">for</span> <span class="nx">el</span> <span class="k">in</span> <span class="nx">obj</span>
    <span class="k">if</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">el</span>
      <span class="nv">list = </span><span class="nx">list</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">listOrigins</span> <span class="nx">el</span>
    <span class="k">else</span>
      <span class="nx">list</span><span class="p">.</span><span class="nx">push</span> <span class="nx">el</span>
  <span class="nx">list</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="load%20origin%20if%20necessary">
  <h3>
    <a href="#load%20origin%20if%20necessary" name="load%20origin%20if%20necessary" class="pilcrow">&#182;</a>
    Load origin if necessary
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">loadOrigin = </span><span class="nf">(origin, cb) -&gt;</span>
  <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span> <span class="k">if</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">loaded</span>
  <span class="nv">uri = </span><span class="k">if</span> <span class="o">~</span><span class="nx">origin</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">indexOf</span> <span class="s">&#39;://&#39;</span> <span class="k">then</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">uri</span> <span class="k">else</span> <span class="s">&#39;file://&#39;</span> <span class="o">+</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">uri</span>
  <span class="p">[</span><span class="nx">proto</span><span class="p">,</span> <span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">split</span> <span class="s">&#39;://&#39;</span>
  <span class="nx">debug</span> <span class="s">&quot;check </span><span class="si">#{</span><span class="nx">uri</span><span class="si">}</span><span class="s">&quot;</span>
  <span class="k">switch</span> <span class="nx">proto</span>
    <span class="k">when</span> <span class="s">&#39;file&#39;</span>
      <span class="k">return</span> <span class="nx">loadFiles</span> <span class="nx">origin</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">cb</span>
    <span class="k">when</span> <span class="s">&#39;http&#39;</span><span class="p">,</span> <span class="s">&#39;https&#39;</span>
      <span class="k">return</span> <span class="nx">loadRequest</span> <span class="nx">origin</span><span class="p">,</span> <span class="nx">uri</span><span class="p">,</span> <span class="nx">cb</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="nx">cb</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Unknown protocol </span><span class="si">#{</span><span class="nx">proto</span><span class="si">}</span><span class="s">&quot;</span>
  <span class="nx">cb</span><span class="p">()</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="load%20file%20origin">
  <h3>
    <a href="#load%20file%20origin" name="load%20file%20origin" class="pilcrow">&#182;</a>
    Load file origin
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">loadFiles = </span><span class="nf">(origin, path, cb) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>find files</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="p">[</span><span class="nx">all</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">pattern</span><span class="p">]</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">match</span> <span class="sr">///</span>
<span class="sr">    ^</span>
<span class="sr">    (</span>
<span class="sr">      [^?*[{@]*$    # everything till end without pattern</span>
<span class="sr">    |</span>
<span class="sr">      [^?*[{@]*\/   # everything without pattern (dirs)</span>
<span class="sr">    )?</span>
<span class="sr">    (.*)            # part containing pattern to end</span>
<span class="sr">    $</span>
<span class="sr">  ///</span>
  <span class="nx">path</span> <span class="o">?=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">()</span> <span class="c1"># make relative links absolute</span>
  <span class="nv">path = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">()</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">unless</span> <span class="nx">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="s">&#39;/&#39;</span>
  <span class="nv">path = </span><span class="nx">fspath</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">path</span>
  <span class="k">unless</span> <span class="nx">pattern</span>
    <span class="nv">file = </span><span class="nx">path</span>
    <span class="nv">path = </span><span class="nx">fspath</span><span class="p">.</span><span class="nx">dirname</span> <span class="nx">path</span> <span class="k">if</span> <span class="nx">path</span><span class="o">?</span>
    <span class="nv">date = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">loadFile</span> <span class="nx">origin</span><span class="p">,</span> <span class="s">&quot;file://</span><span class="si">#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nf">(err, result) -&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">unless</span> <span class="nx">err</span><span class="p">.</span><span class="nx">code</span> <span class="o">is</span> <span class="s">&#39;ENOENT&#39;</span>
        <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">magenta</span> <span class="s">&quot;Failure </span><span class="si">#{</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="s">!&quot;</span>
        <span class="nv">origin.loaded = </span><span class="kc">true</span>
        <span class="nv">origin.lastload = </span><span class="nx">date</span>
        <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span>
      <span class="p">[</span><span class="nx">value</span><span class="p">,</span> <span class="nx">meta</span><span class="p">]</span> <span class="o">=</span> <span class="nx">result</span>
      <span class="nx">setOrigin</span> <span class="nx">origin</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">meta</span><span class="p">,</span> <span class="nx">date</span><span class="p">,</span> <span class="nx">cb</span>
  <span class="nx">fs</span><span class="p">.</span><span class="nx">find</span> <span class="nx">path</span><span class="p">,</span>
    <span class="nv">type: </span><span class="s">&#39;f&#39;</span>
    <span class="nv">include: </span><span class="nx">pattern</span>
    <span class="nv">dereference: </span><span class="kc">true</span>
    <span class="nv">mindepth: </span><span class="nx">path</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\//</span><span class="p">).</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">unless</span> <span class="nx">pattern</span>
    <span class="nv">maxdepth: </span><span class="nx">path</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\//</span><span class="p">).</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">unless</span> <span class="nx">pattern</span>
  <span class="p">,</span> <span class="nf">(err, list) -&gt;</span>
    <span class="nv">date = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span>
      <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">unless</span> <span class="nx">err</span><span class="p">.</span><span class="nx">code</span> <span class="o">is</span> <span class="s">&#39;ENOENT&#39;</span>
      <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">magenta</span> <span class="s">&quot;Failure </span><span class="si">#{</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="s">!&quot;</span>
      <span class="nv">origin.loaded = </span><span class="kc">true</span>
      <span class="nv">origin.lastload = </span><span class="nx">date</span>
      <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>load them</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">path = </span><span class="s">&quot;file:///</span><span class="si">#{</span><span class="nx">string</span><span class="p">.</span><span class="nx">trim</span> <span class="nx">path</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nx">async</span><span class="p">.</span><span class="nx">map</span> <span class="nx">list</span><span class="p">,</span> <span class="nf">(file, cb) -&gt;</span>
      <span class="nx">loadFile</span> <span class="nx">origin</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">cb</span>
    <span class="p">,</span> <span class="nf">(err, objects) -&gt;</span>
      <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>combine</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nv">obj = </span><span class="p">[]</span>
      <span class="nv">meta = </span><span class="p">[]</span>
      <span class="k">for</span> <span class="p">[</span><span class="nx">o</span><span class="p">,</span> <span class="nx">m</span><span class="p">]</span> <span class="k">in</span> <span class="nx">objects</span>
        <span class="nx">obj</span><span class="p">.</span><span class="nx">push</span> <span class="nx">o</span>
        <span class="nx">meta</span><span class="p">.</span><span class="nx">push</span> <span class="nx">m</span>
      <span class="nv">obj = </span><span class="nx">object</span><span class="p">.</span><span class="nx">extend</span><span class="p">.</span><span class="nx">apply</span> <span class="p">{},</span> <span class="nx">obj</span>
      <span class="nv">meta = </span><span class="nx">object</span><span class="p">.</span><span class="nx">extendArrayConcat</span><span class="p">.</span><span class="nx">apply</span> <span class="p">{},</span> <span class="nx">meta</span>
      <span class="nx">setOrigin</span> <span class="nx">origin</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">meta</span><span class="p">,</span> <span class="nx">date</span><span class="p">,</span> <span class="nx">cb</span>

<span class="nv">loadFile = </span><span class="nf">(origin, path, file, cb) -&gt;</span>
  <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">file</span><span class="p">,</span>
    <span class="nv">encoding: </span><span class="s">&#39;UTF-8&#39;</span>
  <span class="p">,</span> <span class="nf">(err, text) -&gt;</span>
    <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<p>parse</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">uri = </span><span class="s">&quot;file:///</span><span class="si">#{</span><span class="nx">string</span><span class="p">.</span><span class="nx">trim</span> <span class="nx">file</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nx">parse</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">uri</span><span class="p">,</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">parser</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nf">(err, obj) -&gt;</span>
      <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>get additional path</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nv">add = </span><span class="nx">uri</span><span class="p">.</span><span class="nx">substring</span> <span class="nx">path</span><span class="p">.</span><span class="nx">length</span><span class="o">+</span><span class="mi">1</span>
      <span class="nv">add = </span><span class="nx">add</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="o">-</span><span class="nx">fspath</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">add</span><span class="p">).</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="nv">add = </span><span class="nx">add</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="o">-</span><span class="mi">7</span><span class="p">]</span> <span class="k">if</span> <span class="nx">string</span><span class="p">.</span><span class="nx">ends</span> <span class="nx">add</span><span class="p">,</span> <span class="s">&#39;/index&#39;</span>
      <span class="nv">list = </span><span class="p">[]</span>
      <span class="k">if</span> <span class="nx">add</span>
        <span class="nv">list = </span><span class="nx">list</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">add</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">..</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="o">~</span><span class="nx">add</span><span class="p">.</span><span class="nx">indexOf</span> <span class="s">&#39;/&#39;</span>
        <span class="nx">list</span><span class="p">.</span><span class="nx">push</span> <span class="nx">fspath</span><span class="p">.</span><span class="nx">basename</span> <span class="nx">add</span>
      <span class="nv">add = </span><span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">list</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;/&#39;</span> <span class="k">if</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>put object deeper</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nv">value = ref = </span><span class="p">{}</span>
      <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">list</span>
        <span class="nx">ref</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nv">ref = </span><span class="nx">ref</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
      <span class="nx">ref</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">obj</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<p>make meta data</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nv">meta = </span><span class="nx">setMeta</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">uri</span><span class="p">,</span> <span class="nx">origin</span>
      <span class="nx">debug</span> <span class="s">&quot;loaded </span><span class="si">#{</span><span class="nx">uri</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="p">[</span><span class="nx">value</span><span class="p">,</span> <span class="nx">meta</span><span class="p">]</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="load%20file%20origin">
  <h3>
    <a href="#load%20file%20origin" name="load%20file%20origin" class="pilcrow">&#182;</a>
    Load file origin
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">loadRequest = </span><span class="nf">(origin, uri, cb) -&gt;</span>
  <span class="nx">debug</span> <span class="s">&quot;load   </span><span class="si">#{</span><span class="nx">uri</span><span class="si">}</span><span class="s">&quot;</span>
  <span class="nv">date = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<p>make request</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">request = </span><span class="nx">require</span> <span class="s">&#39;request&#39;</span>
  <span class="nx">request</span> <span class="nx">uri</span><span class="p">,</span> <span class="nf">(err, response, body) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>error checking</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
    <span class="k">if</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">isnt</span> <span class="mi">200</span>
      <span class="k">return</span> <span class="nx">cb</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Server send wrong return code: </span><span class="si">#{</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span> <span class="k">unless</span> <span class="nx">body</span><span class="o">?</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<p>parse content</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">parse</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">uri</span><span class="p">,</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">parser</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nf">(err, obj) -&gt;</span>
      <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="nv">meta = </span><span class="nx">setMeta</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">uri</span><span class="p">,</span> <span class="nx">origin</span>
      <span class="nx">debug</span> <span class="s">&quot;loaded </span><span class="si">#{</span><span class="nx">uri</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nx">setOrigin</span> <span class="nx">origin</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">meta</span><span class="p">,</span> <span class="nx">date</span><span class="p">,</span> <span class="nx">cb</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="set%20the%20extracted%20information%20to%20the%20origin%20element">
  <h3>
    <a href="#set%20the%20extracted%20information%20to%20the%20origin%20element" name="set%20the%20extracted%20information%20to%20the%20origin%20element" class="pilcrow">&#182;</a>
    Set the extracted information to the origin element
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">setOrigin = </span><span class="nf">(origin, value, meta, date, cb) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<p>set filter</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">filter</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">object</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nx">value</span>
    <span class="nx">debug</span> <span class="s">&quot;set filter to </span><span class="si">#{</span><span class="nx">origin</span><span class="p">.</span><span class="nx">filter</span><span class="si">}</span><span class="s"> in </span><span class="si">#{</span><span class="nx">origin</span><span class="p">.</span><span class="nx">uri</span><span class="si">}</span><span class="s">&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>step into data</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">res = </span><span class="nx">object</span><span class="p">.</span><span class="nx">path</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">filter</span>
    <span class="k">if</span> <span class="nx">res</span><span class="o">?</span>
      <span class="nv">value = </span><span class="nx">res</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>optimize the meta list</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nv">filter = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">origin</span><span class="p">.</span><span class="nx">filter</span><span class="si">}</span><span class="s">/&quot;</span>
      <span class="nv">filter = </span><span class="s">&quot;/</span><span class="si">#{</span><span class="nx">filter</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">unless</span> <span class="nx">filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="s">&#39;/&#39;</span>
      <span class="nv">res = </span><span class="p">{}</span>
      <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">meta</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>remove entries not starting with /filter/</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">continue</span> <span class="k">unless</span> <span class="nx">string</span><span class="p">.</span><span class="nx">starts</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">filter</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33">&#182;</a>
</div>
<p>replace /filter/ with / in all meta paths</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">res</span><span class="p">[</span><span class="nx">k</span><span class="p">.</span><span class="nx">substring</span> <span class="nx">filter</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>
      <span class="nv">meta = </span><span class="nx">res</span>
    <span class="k">else</span>
      <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">red</span> <span class="s">&quot;Could not set filter </span><span class="si">#{</span><span class="nx">origin</span><span class="p">.</span><span class="nx">filter</span><span class="si">}</span><span class="s"> in </span><span class="si">#{</span><span class="nx">origin</span><span class="p">.</span><span class="nx">uri</span><span class="si">}</span><span class="s">&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>
<p>set specific path</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">path</span>
    <span class="nx">debug</span> <span class="s">&quot;set under path </span><span class="si">#{</span><span class="nx">origin</span><span class="p">.</span><span class="nx">path</span><span class="si">}</span><span class="s"> for </span><span class="si">#{</span><span class="nx">origin</span><span class="p">.</span><span class="nx">uri</span><span class="si">}</span><span class="s">&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<p>add path to value</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">path = </span><span class="nx">string</span><span class="p">.</span><span class="nx">trim</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="s">&#39;/&#39;</span>
    <span class="nv">obj = ref = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">path</span><span class="p">.</span><span class="nx">split</span> <span class="s">&#39;/&#39;</span>
      <span class="nx">ref</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="nv">ref = </span><span class="nx">ref</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
    <span class="nx">ref</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">value</span>
    <span class="nv">value = </span><span class="nx">obj</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>add path to meta</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">ref = </span><span class="p">{}</span>
    <span class="nx">ref</span><span class="p">[</span><span class="s">&quot;/</span><span class="si">#{</span><span class="nx">path</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">k</span><span class="si">}</span><span class="s">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">meta</span>
    <span class="nv">meta = </span><span class="nx">ref</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<p>store in origin</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">origin.value = </span><span class="nx">value</span>
  <span class="nv">origin.meta = </span><span class="nx">meta</span>
  <span class="nv">origin.lastload = </span><span class="nx">date</span>
  <span class="nx">debug</span> <span class="s">&quot;loaded </span><span class="si">#{</span><span class="nx">origin</span><span class="p">.</span><span class="nx">path</span> <span class="o">?</span> <span class="s">&#39;ROOT&#39;</span><span class="si">}</span><span class="s"> with: \n</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38">&#182;</a>
</div>
<p>{ chalk.grey util.inspect origin.value, {depth: null}}"</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="s">  cb()</span>

<span class="s">ext2parser =</span>
<span class="s">  yml: &#39;yaml&#39;</span>
<span class="s">  yaml: &#39;yaml&#39;</span>
<span class="s">  js: &#39;js&#39;</span>
<span class="s">  javascript: &#39;javascript&#39;</span>
<span class="s">  json: &#39;json&#39;</span>
<span class="s">  cson: &#39;coffee&#39;</span>
<span class="s">  coffee: &#39;coffee&#39;</span>
<span class="s">  xml: &#39;xml&#39;</span>
<span class="s">  ini: &#39;ini&#39;</span>
<span class="s">  properties: &#39;properties&#39;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="parse%20text%20into%20object">
  <h3>
    <a href="#parse%20text%20into%20object" name="parse%20text%20into%20object" class="pilcrow">&#182;</a>
    Parse text into object
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="s">parse = (text, uri, parser, quiet=false, cb) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40">&#182;</a>
</div>
<p>auto detection</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="s">  list = [&#39;xml&#39;, &#39;ini&#39;, &#39;properties&#39;, &#39;coffee&#39;, &#39;yaml&#39;, &#39;json&#39;, &#39;js&#39;]</span>
<span class="s">  unless parser in list</span>
<span class="s">    detect = list[0..]</span>
<span class="s">    ext = fspath.extname(uri).substring 1</span>
<span class="s">    if type = ext2parser[ext]</span>
<span class="s">      i = detect.indexOf type</span>
<span class="s">      detect.splice i, 1 if i &gt; -1</span>
<span class="s">      detect.unshift type</span>
<span class="s">    debug &quot;</span><span class="nx">autodetect</span> <span class="nx">format</span> <span class="nv">as: </span><span class="c1">#{detect}&quot;</span>
    <span class="nv">result = </span><span class="kc">null</span>
    <span class="nv">errors = </span><span class="p">[]</span>
    <span class="nx">async</span><span class="p">.</span><span class="nx">detectSeries</span> <span class="nx">detect</span><span class="p">,</span> <span class="nf">(type, cb) -&gt;</span>
      <span class="nx">parseFormat</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">uri</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nf">(err, obj) -&gt;</span>
        <span class="k">if</span> <span class="nx">err</span>
          <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span>
          <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">uri</span><span class="si">}</span><span class="s"> failed in </span><span class="si">#{</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nv">result = </span><span class="nx">obj</span>
        <span class="nx">cb</span> <span class="o">not</span> <span class="nx">err</span><span class="o">?</span> <span class="o">and</span> <span class="nx">obj</span><span class="o">?</span>
    <span class="p">,</span> <span class="nf">(ok) -&gt;</span>
      <span class="k">unless</span> <span class="nx">ok</span>
        <span class="k">return</span> <span class="nx">cb</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Could not find any valid format for </span><span class="si">#{</span><span class="nx">uri</span><span class="si">}</span><span class="s">:\n</span><span class="si">#{</span><span class="nx">errors</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;\n&#39;</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">result</span>
    <span class="k">return</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41">&#182;</a>
</div>
<p>parse direct given format only</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">parseFormat</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">uri</span><span class="p">,</span> <span class="nx">parser</span><span class="p">,</span> <span class="nx">quiet</span><span class="p">,</span> <span class="nf">(err, result) -&gt;</span>
    <span class="nv">err = </span><span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">uri</span><span class="si">}</span><span class="s"> failed in </span><span class="si">#{</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">if</span> <span class="nx">err</span>
    <span class="nx">cb</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">result</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="parse%20given%20format">
  <h3>
    <a href="#parse%20given%20format" name="parse%20given%20format" class="pilcrow">&#182;</a>
    Parse given Format
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">parseFormat = </span> <span class="nf">(text, uri, parser, quiet=false, cb) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43">&#182;</a>
</div>
<p>parse specified format</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">color = </span><span class="k">if</span> <span class="nx">quiet</span> <span class="k">then</span> <span class="s">&#39;grey&#39;</span> <span class="k">else</span> <span class="s">&#39;red&#39;</span>
  <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;try loading </span><span class="si">#{</span><span class="nx">uri</span><span class="si">}</span><span class="s"> as </span><span class="si">#{</span><span class="nx">parser</span><span class="si">}</span><span class="s">&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44">&#182;</a>
</div>
<p>parser given</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">switch</span> <span class="nx">parser</span>
    <span class="k">when</span> <span class="s">&#39;yaml&#39;</span>
      <span class="nv">yaml = </span><span class="nx">require</span> <span class="s">&#39;js-yaml&#39;</span>
      <span class="k">try</span>
        <span class="nv">result = </span><span class="nx">yaml</span><span class="p">.</span><span class="nx">safeLoad</span> <span class="nx">text</span>
      <span class="k">catch</span> <span class="nx">err</span>
        <span class="nv">err.message = </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">replace</span> <span class="s">&#39;JS-YAML: &#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span>
        <span class="k">return</span> <span class="nx">cb</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">parser</span><span class="si">}</span><span class="s"> parser: </span><span class="si">#{</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/[\s^]+/g</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">result</span>
    <span class="k">when</span> <span class="s">&#39;js&#39;</span>
      <span class="nv">vm = </span><span class="nx">require</span> <span class="s">&#39;vm&#39;</span>
      <span class="k">try</span>
        <span class="nv">result = </span><span class="nx">vm</span><span class="p">.</span><span class="nx">runInNewContext</span> <span class="s">&quot;x=</span><span class="si">#{</span><span class="nx">text</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="k">catch</span> <span class="nx">err</span>
        <span class="k">return</span> <span class="nx">cb</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">parser</span><span class="si">}</span><span class="s"> parser: </span><span class="si">#{</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">result</span>
    <span class="k">when</span> <span class="s">&#39;json&#39;</span>
      <span class="k">try</span>
        <span class="nv">result = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">text</span>
      <span class="k">catch</span> <span class="nx">err</span>
        <span class="k">return</span> <span class="nx">cb</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">parser</span><span class="si">}</span><span class="s"> parser: </span><span class="si">#{</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">result</span>
    <span class="k">when</span> <span class="s">&#39;coffee&#39;</span>
      <span class="nv">coffee = </span><span class="nx">require</span> <span class="s">&#39;coffee-script&#39;</span>
      <span class="k">try</span>
        <span class="nv">text = </span><span class="s">&quot;module.exports =\n  &quot;</span> <span class="o">+</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/\n/g</span><span class="p">,</span> <span class="s">&#39;\n  &#39;</span>
        <span class="nv">m = </span><span class="k">new</span> <span class="nx">module</span><span class="p">.</span><span class="nx">constructor</span><span class="p">()</span>
        <span class="nx">m</span><span class="p">.</span><span class="nx">_compile</span> <span class="nx">coffee</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">text</span><span class="p">),</span> <span class="nx">uri</span>
      <span class="k">catch</span> <span class="nx">err</span>
        <span class="k">return</span> <span class="nx">cb</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">parser</span><span class="si">}</span><span class="s"> parser: </span><span class="si">#{</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">exports</span>
    <span class="k">when</span> <span class="s">&#39;properties&#39;</span>
      <span class="nv">properties = </span><span class="nx">require</span> <span class="s">&#39;properties&#39;</span>
      <span class="nx">properties</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">text</span><span class="p">,</span>
        <span class="nv">sections: </span><span class="kc">true</span>
        <span class="nv">namespaces: </span><span class="kc">true</span>
      <span class="p">,</span> <span class="nf">(err, result) -&gt;</span>
        <span class="k">if</span> <span class="nx">err</span>
          <span class="k">return</span> <span class="nx">cb</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">parser</span><span class="si">}</span><span class="s"> parser: </span><span class="si">#{</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="k">unless</span> <span class="nx">propertiesCheck</span> <span class="nx">result</span>
          <span class="k">return</span> <span class="nx">cb</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">parser</span><span class="si">}</span><span class="s"> parser: Unexpected characters []{}/ in key name found&quot;</span>
        <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">result</span>
    <span class="k">when</span> <span class="s">&#39;ini&#39;</span>
      <span class="nv">ini = </span><span class="nx">require</span> <span class="s">&#39;ini&#39;</span>
      <span class="k">try</span>
        <span class="nv">result = </span><span class="nx">ini</span><span class="p">.</span><span class="nx">decode</span> <span class="nx">text</span>
      <span class="k">catch</span> <span class="nx">err</span>
        <span class="k">return</span> <span class="nx">cb</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">parser</span><span class="si">}</span><span class="s"> parser: </span><span class="si">#{</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="s">&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45">&#182;</a>
</div>
<p>detect failed parsing</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">result</span><span class="o">?</span>
        <span class="k">return</span> <span class="nx">cb</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">parser</span><span class="si">}</span><span class="s"> parser: could not parse any result&quot;</span>
      <span class="k">if</span> <span class="nx">result</span><span class="p">[</span><span class="s">&#39;{&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="nx">cb</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">parser</span><span class="si">}</span><span class="s"> parser: Unexpected token { at start&quot;</span>
      <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">result</span>
        <span class="k">if</span> <span class="nx">v</span> <span class="o">is</span> <span class="kc">true</span> <span class="o">and</span> <span class="nx">k</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/:/</span>
          <span class="k">return</span> <span class="nx">cb</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">parser</span><span class="si">}</span><span class="s"> parser: Unexpected key name containing &#39;:&#39; with value true&quot;</span>
      <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">result</span>
    <span class="k">when</span> <span class="s">&#39;xml&#39;</span>
      <span class="nv">xml2js = </span><span class="nx">require</span> <span class="s">&#39;xml2js&#39;</span>
      <span class="nx">xml2js</span><span class="p">.</span><span class="nx">parseString</span> <span class="nx">text</span><span class="p">,</span> <span class="p">{</span><span class="nv">explicitArray: </span><span class="kc">false</span><span class="p">},</span> <span class="nf">(err, result) -&gt;</span>
        <span class="k">if</span> <span class="nx">err</span>
          <span class="k">return</span> <span class="nx">cb</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">parser</span><span class="si">}</span><span class="s"> parser: </span><span class="si">#{</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/\n/g</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="si">}</span><span class="s">&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46">&#182;</a>
</div>
<p>optimize result of attributes</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">xmlOptimize</span> <span class="nx">result</span>
    <span class="k">else</span>
      <span class="nx">cb</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Parser for </span><span class="si">#{</span><span class="nx">parser</span><span class="si">}</span><span class="s"> not found&quot;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="optimize%20parsed%20cml">
  <h3>
    <a href="#optimize%20parsed%20cml" name="optimize%20parsed%20cml" class="pilcrow">&#182;</a>
    Optimize parsed cml
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">xmlOptimize = </span><span class="nf">(data) -&gt;</span>
  <span class="k">return</span> <span class="nx">data</span> <span class="k">unless</span> <span class="k">typeof</span> <span class="nx">data</span> <span class="o">is</span> <span class="s">&#39;object&#39;</span>
  <span class="k">if</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">data</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48">&#182;</a>
</div>
<p>seep analyze array</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">result = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">data</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">push</span> <span class="nx">xmlOptimize</span> <span class="nx">v</span>
    <span class="k">return</span> <span class="nx">result</span>
  <span class="nv">result = </span><span class="p">{}</span>
  <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">data</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49">&#182;</a>
</div>
<p>set value</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="nx">k</span> <span class="o">is</span> <span class="s">&#39;_&#39;</span>
      <span class="nv">result.value = </span><span class="nx">v</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50">&#182;</a>
</div>
<p>set attributes</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">k</span> <span class="o">is</span> <span class="s">&#39;$&#39;</span>
      <span class="k">for</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">w</span> <span class="k">of</span> <span class="nx">xmlOptimize</span> <span class="nx">v</span>
        <span class="nx">result</span><span class="p">[</span><span class="nx">s</span><span class="p">]</span> <span class="o">=</span> <span class="nx">w</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51">&#182;</a>
</div>
<p>keep other but check contents</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">else</span>
      <span class="nx">result</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">xmlOptimize</span> <span class="nx">v</span>
  <span class="k">return</span> <span class="nx">result</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="check%20that%20the%20properties%20parser%20for%20correct%20result">
  <h3>
    <a href="#check%20that%20the%20properties%20parser%20for%20correct%20result" name="check%20that%20the%20properties%20parser%20for%20correct%20result" class="pilcrow">&#182;</a>
    Check that the properties parser for correct result
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">propertiesCheck = </span><span class="nf">(data) -&gt;</span>
  <span class="k">return</span> <span class="kc">true</span> <span class="k">unless</span> <span class="k">typeof</span> <span class="nx">data</span> <span class="o">is</span> <span class="s">&#39;object&#39;</span>
  <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">data</span>
    <span class="k">if</span> <span class="nx">v</span> <span class="o">is</span> <span class="kc">null</span> <span class="o">or</span> <span class="o">~</span><span class="s">&#39;[]{}/&#39;</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">k</span><span class="p">.</span><span class="nx">charAt</span> <span class="mi">0</span>
      <span class="k">return</span> <span class="kc">false</span>
    <span class="k">return</span> <span class="kc">false</span> <span class="k">unless</span> <span class="nx">propertiesCheck</span> <span class="nx">v</span>
  <span class="k">return</span> <span class="kc">true</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="set%20meta%20data%20to%20all%20elements">
  <h3>
    <a href="#set%20meta%20data%20to%20all%20elements" name="set%20meta%20data%20to%20all%20elements" class="pilcrow">&#182;</a>
    Set Meta Data to all elements
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">setMeta = </span><span class="nf">(obj, uri, origin, prefix=&#39;&#39;) -&gt;</span>
  <span class="nv">meta = </span><span class="p">{}</span>
  <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">obj</span>
    <span class="nv">path = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">prefix</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">k</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">v</span> <span class="o">is</span> <span class="s">&#39;object&#39;</span>
      <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">val</span> <span class="k">of</span> <span class="nx">setMeta</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">uri</span><span class="p">,</span> <span class="nx">origin</span><span class="p">,</span> <span class="nx">path</span>
        <span class="nx">meta</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span>
    <span class="k">else</span>
      <span class="nx">meta</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nv">uri: </span><span class="nx">uri</span>
        <span class="nv">origin: </span><span class="nx">origin</span>
        <span class="nv">value: </span><span class="nx">v</span>
      <span class="p">]</span>
  <span class="k">return</span> <span class="nx">meta</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
